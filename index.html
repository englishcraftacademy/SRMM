<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spaced Repetition Pronunciation Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .card.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .card-face-back {
            transform: rotateY(180deg);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Authentication Screen -->
    <div id="auth-screen" class="w-full max-w-sm mx-auto bg-white rounded-2xl shadow-lg p-8 space-y-6">
        <div class="text-center">
            <h1 class="text-2xl font-bold text-gray-900">Pronunciation Practice</h1>
            <p class="text-gray-500">Sign in or create an account</p>
        </div>
        <form id="login-form" class="space-y-4">
            <input type="email" id="login-email" placeholder="Email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">Sign In</button>
        </form>
        <div class="text-center text-sm text-gray-600">
            <p>Don't have an account? <a href="#" id="show-signup" class="font-medium text-blue-600 hover:underline">Sign Up</a></p>
        </div>
        <form id="signup-form" class="space-y-4 hidden">
            <input type="email" id="signup-email" placeholder="Email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">Create Account</button>
        </form>
         <div class="text-center text-sm text-gray-600 hidden" id="signup-message">
            <p>Already have an account? <a href="#" id="show-login" class="font-medium text-blue-600 hover:underline">Sign In</a></p>
        </div>
        <p id="auth-error" class="text-red-500 text-center text-sm mt-2"></p>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8 space-y-6 hidden">
        <div class="flex justify-between items-center">
            <div class="text-left">
                 <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Pronunciation Practice</h1>
                 <p id="user-email-display" class="text-xs text-gray-400 mt-1"></p>
            </div>
            <button id="logout-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-lg text-sm transition">Log Out</button>
        </div>

        <!-- Loading Indicator -->
        <div id="loader" class="flex justify-center items-center h-64">
            <div class="loader"></div>
        </div>

        <!-- Deck Selection Screen -->
        <div id="deck-selection-screen" class="space-y-4">
            <h2 class="text-xl font-semibold text-center">Choose a Deck</h2>
            <div id="deck-list" class="space-y-3"></div>
        </div>

        <!-- Practice Screen -->
        <div id="practice-screen" class="hidden">
            <div id="stats" class="flex justify-between text-sm text-gray-500 mb-4">
                <span id="new-count">New: 0</span>
                <span id="review-count">To Review: 0</span>
                <span id="done-count">Done: 0</span>
            </div>
            <div id="card-container" class="relative h-64 w-full cursor-pointer perspective-1000">
                <div id="flashcard" class="card w-full h-full">
                    <div id="card-front" class="card-face flex flex-col items-center justify-center p-6 bg-blue-500 text-white rounded-xl shadow-md">
                        <p id="card-front-text" class="text-2xl md:text-3xl font-semibold text-center"></p>
                        <button id="play-audio-btn" class="mt-4 p-3 rounded-full bg-blue-600 hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.88 12H4a1 1 0 00-1 1v2a1 1 0 001 1h1.88l5.3 5.3a1 1 0 001.62-.7V5.4a1 1 0 00-1.62-.7L5.88 12z"></path></svg>
                        </button>
                    </div>
                    <div id="card-back" class="card-face card-face-back flex flex-col items-center justify-center p-6 bg-blue-700 text-white rounded-xl shadow-md">
                        <p id="card-back-text" class="text-xl md:text-2xl font-medium text-center"></p>
                        <p id="card-back-ipa" class="text-lg text-blue-200 mt-2"></p>
                    </div>
                </div>
            </div>
            <div id="answer-buttons" class="mt-6 grid grid-cols-3 gap-3 hidden">
                <button id="hard-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition">Hard</button>
                <button id="good-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg transition">Good</button>
                <button id="easy-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition">Easy</button>
            </div>
            <button id="show-answer-btn" class="mt-6 w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-4 rounded-lg transition">Show Answer</button>
        </div>

        <!-- All Done Screen -->
        <div id="all-done-screen" class="hidden text-center py-16">
            <h2 class="text-2xl font-bold text-green-500">Great job!</h2>
            <p class="mt-2 text-gray-600">You've finished all your reviews for now.</p>
            <button id="back-to-decks-btn" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition">Choose Another Deck</button>
        </div>
    </div>
    
    <audio id="card-audio-player"></audio>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // This event listener ensures that the script runs only after the entire page is loaded.
        window.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed. Starting script.");

            // --- CONFIGURATION ---
            const firebaseConfig = {
                apiKey: "AIzaSyDrsyLfZZ6EAmceJRAF1ZbvJlQgsiAJTmM",
                authDomain: "srmm-fb551.firebaseapp.com",
                projectId: "srmm-fb551",
                storageBucket: "srmm-fb551.firebasestorage.app",
                messagingSenderId: "726243713127",
                appId: "1:726243713127:web:97af2dc2e117e1d9c074c2"
            };
            
            const appId = 'srs-pronunciation-app';

            let app, auth, db, userId;
            try {
                console.log("Attempting to initialize Firebase...");
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized successfully.");
            } catch (e) {
                console.error("CRITICAL ERROR during Firebase initialization:", e);
                document.body.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative max-w-lg mx-auto mt-10" role="alert"><strong class="font-bold">Initialization Error:</strong><p class="block sm:inline">${e.message}</p></div>`;
                return; // Stop execution if Firebase fails
            }
            
            const LOCAL_SAMPLE_DECK = {
                id: "common-business-words",
                name: "Common Business Words",
                description: "Essential vocabulary for meetings and presentations.",
                cards: [
                    { front: "Schedule", audioUrl: "https://ssl.gstatic.com/dictionary/static/sounds/20200429/schedule--_us_1.mp3", back: { explanation: "Pronounced 'SKED-jool' in AmE, not 'SHED-yool'.", ipa: "/ˈskɛdʒ.uːl/" }},
                    { front: "Hierarchy", audioUrl: "https://ssl.gstatic.com/dictionary/static/sounds/20200429/hierarchy--_us_1.mp3", back: { explanation: "Focus on the 'HI-er-ar-ky' sound.", ipa: "/ˈhaɪ.ə.rɑːr.ki/" }},
                    { front: "Colleague", audioUrl: "https://ssl.gstatic.com/dictionary/static/sounds/20200429/colleague--_us_1.mp3", back: { explanation: "Stress is on the first syllable: 'KO-leeg'.", ipa: "/ˈkɒl.iːɡ/" }},
                    { front: "Entrepreneur", audioUrl: "https://ssl.gstatic.com/dictionary/static/sounds/20200429/entrepreneur--_us_1.mp3", back: { explanation: "A tricky one! 'on-truh-pruh-NUR'.", ipa: "/ˌɒn.trə.prəˈnɜːr/" }},
                    { front: "Negotiate", audioUrl: "https://ssl.gstatic.com/dictionary/static/sounds/20200429/negotiate--_us_1.mp3", back: { explanation: "Pronounced 'ne-GO-she-ate'.", ipa: "/nəˈɡoʊ.ʃi.eɪt/" }}
                ]
            };

            // --- DOM ELEMENTS ---
            const authScreen = document.getElementById('auth-screen');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const authError = document.getElementById('auth-error');
            const showSignup = document.getElementById('show-signup');
            const showLogin = document.getElementById('show-login');
            const signupMessage = document.getElementById('signup-message');
            const logoutBtn = document.getElementById('logout-btn');
            const userEmailDisplay = document.getElementById('user-email-display');
            const loader = document.getElementById('loader');
            const deckSelectionScreen = document.getElementById('deck-selection-screen');
            const practiceScreen = document.getElementById('practice-screen');
            const allDoneScreen = document.getElementById('all-done-screen');
            const flashcard = document.getElementById('flashcard');
            const cardFrontText = document.getElementById('card-front-text');
            const cardBackText = document.getElementById('card-back-text');
            const cardBackIpa = document.getElementById('card-back-ipa');
            const playAudioBtn = document.getElementById('play-audio-btn');
            const audioPlayer = document.getElementById('card-audio-player');
            const showAnswerBtn = document.getElementById('show-answer-btn');
            const answerButtons = document.getElementById('answer-buttons');
            const hardBtn = document.getElementById('hard-btn');
            const goodBtn = document.getElementById('good-btn');
            const easyBtn = document.getElementById('easy-btn');
            const newCountEl = document.getElementById('new-count');
            const reviewCountEl = document.getElementById('review-count');
            const doneCountEl = document.getElementById('done-count');
            const backToDecksBtn = document.getElementById('back-to-decks-btn');

            // --- APP STATE ---
            let masterDeck = [];
            let userProgress = [];
            let queue = [];
            let currentCard = null;
            let stats = { new: 0, review: 0, done: 0 };
            
            // --- SPACED REPETITION LOGIC ---
            const SRS = { getCardProgress(cardIndex) { return userProgress.find(p => p.cardIndex === cardIndex); }, updateCardProgress(cardIndex, quality) { let progress = this.getCardProgress(cardIndex); if (!progress) { progress = { cardIndex, interval: 0, easeFactor: 2.5, nextReview: new Date().toISOString() }; userProgress.push(progress); } if (quality < 1) { progress.interval = 1; progress.easeFactor = Math.max(1.3, progress.easeFactor - 0.2); } else { if (progress.interval === 0) progress.interval = 1; else if (progress.interval === 1) progress.interval = 6; else progress.interval = Math.round(progress.interval * progress.easeFactor); if (quality === 2) { progress.easeFactor += 0.15; progress.interval = Math.round(progress.interval * 1.3); } } const nextReviewDate = new Date(); nextReviewDate.setDate(nextReviewDate.getDate() + progress.interval); progress.nextReview = nextReviewDate.toISOString(); } };
            
            // --- UI FUNCTIONS ---
            function showScreen(screen) { loader.classList.add('hidden'); deckSelectionScreen.classList.add('hidden'); practiceScreen.classList.add('hidden'); allDoneScreen.classList.add('hidden'); screen.classList.remove('hidden'); }
            function updateStatsUI() { newCountEl.textContent = `New: ${stats.new}`; reviewCountEl.textContent = `To Review: ${stats.review}`; doneCountEl.textContent = `Done: ${stats.done}`; }
            function displayCard(cardData) { flashcard.classList.remove('is-flipped'); cardFrontText.textContent = cardData.front; cardBackText.textContent = cardData.back.explanation; cardBackIpa.textContent = cardData.back.ipa; if (cardData.audioUrl) { audioPlayer.src = cardData.audioUrl; playAudioBtn.classList.remove('hidden'); } else { playAudioBtn.classList.add('hidden'); } showAnswerBtn.classList.remove('hidden'); answerButtons.classList.add('hidden'); }
            
            // --- MAIN APP FLOW ---
            function buildQueue() { const now = new Date().toISOString(); const newCards = []; const reviewCards = []; masterDeck.forEach((card, index) => { const progress = SRS.getCardProgress(index); if (!progress) newCards.push({ cardIndex: index, type: 'new' }); else if (progress.nextReview <= now) reviewCards.push({ cardIndex: index, type: 'review' }); }); queue = [...reviewCards, ...newCards.slice(0, 10)]; stats = { new: newCards.length, review: reviewCards.length, done: 0 }; updateStatsUI(); }
            function nextCard() { if (queue.length > 0) { currentCard = queue.shift(); const cardData = masterDeck[currentCard.cardIndex]; displayCard(cardData); } else { saveProgress(); showScreen(allDoneScreen); } }
            async function startPractice(deckId, isLocal = false) { showScreen(loader); practiceScreen.dataset.deckId = deckId; await loadDeckAndProgress(deckId, isLocal); buildQueue(); if (queue.length > 0) { showScreen(practiceScreen); nextCard(); } else { showScreen(allDoneScreen); } }
            function handleAnswer(quality) { SRS.updateCardProgress(currentCard.cardIndex, quality); if (currentCard.type === 'new') stats.new--; else stats.review--; stats.done++; updateStatsUI(); nextCard(); }
            
            // --- DATA HANDLING ---
            async function loadDecks() {
                console.log("Step 1: Starting loadDecks function.");
                try {
                    showScreen(loader);
                    console.log("Step 2: Loader is visible.");
                    const deckList = document.getElementById('deck-list');
                    if (!deckList) {
                        console.error("Deck list element not found!");
                        return;
                    }
                    deckList.innerHTML = '';
                    const localDeck = LOCAL_SAMPLE_DECK;
                    const localButton = document.createElement('button');
                    localButton.className = "w-full text-left p-4 bg-gray-100 hover:bg-blue-100 rounded-lg transition";
                    localButton.innerHTML = `<h3 class="font-semibold text-lg">${localDeck.name}</h3><p class="text-sm text-gray-600">${localDeck.description}</p>`;
                    localButton.onclick = () => startPractice(localDeck.id, true);
                    deckList.appendChild(localButton);
                    
                    console.log("Step 3: Local deck button has been created and added.");
                    showScreen(deckSelectionScreen);
                    console.log("Step 4: Deck selection screen should now be visible.");
                } catch (error) {
                    console.error("CRITICAL ERROR in loadDecks:", error);
                }
            }
            async function loadDeckAndProgress(deckId, isLocal = false) { if (isLocal) { masterDeck = LOCAL_SAMPLE_DECK.cards; } else { const deckRef = doc(db, `artifacts/${appId}/public/data/decks`, deckId); const deckSnap = await getDoc(deckRef); if (!deckSnap.exists()) { console.error("Deck not found!"); return; } masterDeck = deckSnap.data().cards; } const progressRef = doc(db, `artifacts/${appId}/users/${userId}/progress`, deckId); const progressSnap = await getDoc(progressRef); userProgress = progressSnap.exists() ? progressSnap.data().progress || [] : []; }
            async function saveProgress() { if (!userId || !currentCard) return; const deckId = practiceScreen.dataset.deckId; const progressRef = doc(db, `artifacts/${appId}/users/${userId}/progress`, deckId); try { await setDoc(progressRef, { progress: userProgress }, { merge: true }); } catch (error) { console.error("Error saving progress: ", error); } }
            
            // --- AUTHENTICATION LOGIC ---
            if (auth) {
                console.log("Auth service is ready. Setting up listener.");
                onAuthStateChanged(auth, async (user) => { 
                    if (user) { 
                        console.log("User is signed in:", user.uid);
                        userId = user.uid; 
                        userEmailDisplay.textContent = user.email; 
                        authScreen.classList.add('hidden'); 
                        appContainer.classList.remove('hidden'); 
                        await loadDecks(); 
                    } else { 
                        console.log("No user is signed in.");
                        userId = null; 
                        appContainer.classList.add('hidden'); 
                        authScreen.classList.remove('hidden'); 
                    } 
                });
                loginForm.addEventListener('submit', async (e) => { e.preventDefault(); authError.textContent = ''; const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { authError.textContent = error.message; } });
                signupForm.addEventListener('submit', async (e) => { e.preventDefault(); authError.textContent = ''; const email = document.getElementById('signup-email').value; const password = document.getElementById('signup-password').value; try { await createUserWithEmailAndPassword(auth, email, password); } catch (error) { authError.textContent = error.message; } });
                logoutBtn.addEventListener('click', async () => { await signOut(auth); });
                showSignup.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); document.querySelector('.text-sm.text-gray-600').classList.add('hidden'); signupMessage.classList.remove('hidden'); });
                showLogin.addEventListener('click', (e) => { e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); signupMessage.classList.add('hidden'); document.querySelector('.text-sm.text-gray-600').classList.remove('hidden'); });
            }
            
            // --- EVENT LISTENERS ---
            flashcard.addEventListener('click', () => { flashcard.classList.add('is-flipped'); showAnswerBtn.classList.add('hidden'); answerButtons.classList.remove('hidden'); });
            showAnswerBtn.addEventListener('click', (e) => { e.stopPropagation(); flashcard.click(); });
            playAudioBtn.addEventListener('click', (e) => { e.stopPropagation(); audioPlayer.play().catch(error => console.error("Audio playback error:", error)); });
            hardBtn.addEventListener('click', () => handleAnswer(0));
            goodBtn.addEventListener('click', () => handleAnswer(1));
            easyBtn.addEventListener('click', () => handleAnswer(2));
            backToDecksBtn.addEventListener('click', () => loadDecks());
        });
    </script>
</body>
</html>
